name: Site

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  deploy-site:
    name: Build and publish Maven site
    runs-on: ubuntu-latest
    # Run on main (SNAPSHOT site) and version tags (release site) only
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 30

    permissions:
      contents: write  # to maintain the gh-pages storage branch
      pages: write     # to deploy to GitHub Pages
      id-token: write  # OIDC token required by actions/deploy-pages

    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build Maven site
        run: ./mvnw -B -ntp -DskipTests package site

      # Check out the accumulated gh-pages content so we can overlay new files
      # and re-deploy the full site (native Pages has no keep_files equivalent).
      # continue-on-error handles the first run when the branch doesn't exist yet.
      - name: Checkout gh-pages storage branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: gh-pages
          path: target/gh-pages-store
        continue-on-error: true

      - name: Initialize gh-pages store if branch does not exist yet
        run: |
          if [ ! -d target/gh-pages-store/.git ]; then
            git init target/gh-pages-store
            git -C target/gh-pages-store checkout -b gh-pages
          fi

      - name: Update snapshot content
        if: github.ref == 'refs/heads/main'
        run: |
          rm -rf target/gh-pages-store/snapshot
          mkdir -p target/gh-pages-store/snapshot
          cp -r target/site/. target/gh-pages-store/snapshot/

      - name: Update release content
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          version="${GITHUB_REF_NAME#v}"
          rm -rf "target/gh-pages-store/$version" target/gh-pages-store/latest
          mkdir -p "target/gh-pages-store/$version" target/gh-pages-store/latest
          cp -r target/site/. "target/gh-pages-store/$version/"
          cp -r target/site/. target/gh-pages-store/latest/

      - name: Configure Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3
        with:
          path: target/gh-pages-store

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4

      # Push the updated tree back so the next run can check it out.
      - name: Commit and push gh-pages storage branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git -C target/gh-pages-store config user.name "github-actions[bot]"
          git -C target/gh-pages-store config user.email "github-actions[bot]@users.noreply.github.com"
          git -C target/gh-pages-store add -A
          if git -C target/gh-pages-store diff --cached --quiet; then
            echo "No changes to commit"
          else
            git -C target/gh-pages-store commit -m "chore: update site for ${GITHUB_REF_NAME}"
            git -C target/gh-pages-store remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" 2>/dev/null \
              || git -C target/gh-pages-store remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git -C target/gh-pages-store push origin gh-pages
          fi
