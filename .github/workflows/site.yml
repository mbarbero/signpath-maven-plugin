name: Site

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  deploy-site:
    name: Build and publish Maven site
    runs-on: ubuntu-latest
    # Run on main (SNAPSHOT site) and version tags (release site) only
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 30

    permissions:
      contents: write  # to maintain the gh-pages storage branch
      pages: write     # to deploy to GitHub Pages
      id-token: write  # OIDC token required by actions/deploy-pages

    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Set up Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: temurin
          java-version: '21'

      - name: Build Maven site
        run: ./mvnw -B -ntp -DskipTests package site

      # Check out the accumulated gh-pages content so we can overlay new files
      # and re-deploy the full site (native Pages has no keep_files equivalent).
      # continue-on-error handles the first run when the branch doesn't exist yet.
      - name: Checkout gh-pages storage branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: gh-pages
          path: target/gh-pages-store
          persist-credentials: false
        continue-on-error: true

      - name: Initialize gh-pages store if branch does not exist yet
        run: |
          if [ ! -d target/gh-pages-store/.git ]; then
            git init target/gh-pages-store
            git -C target/gh-pages-store checkout -b gh-pages
          fi

      - name: Update snapshot content
        if: github.ref == 'refs/heads/main'
        run: |
          rm -rf target/gh-pages-store/snapshot
          mkdir -p target/gh-pages-store/snapshot
          cp -r target/site/. target/gh-pages-store/snapshot/

      - name: Update release content
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          version="${GITHUB_REF_NAME#v}"
          rm -rf "target/gh-pages-store/$version" target/gh-pages-store/latest
          mkdir -p "target/gh-pages-store/$version" target/gh-pages-store/latest
          cp -r target/site/. "target/gh-pages-store/$version/"
          cp -r target/site/. target/gh-pages-store/latest/

      - name: Generate root index page
        run: |
          python3 << 'PYEOF'
          import os, re

          store = "target/gh-pages-store"

          versions = sorted(
              [e.name for e in os.scandir(store)
               if e.is_dir() and re.match(r'^\d', e.name)],
              key=lambda v: tuple(
                  (0, int(x)) if x.isdigit() else (1, x)
                  for x in re.split(r'[.\-]', v)
              ),
              reverse=True
          )

          has_latest = os.path.isdir(os.path.join(store, 'latest'))
          has_snapshot = os.path.isdir(os.path.join(store, 'snapshot'))

          css = (
              'body{'
              'font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;'
              'max-width:800px;margin:0 auto;padding:2rem;color:#333}'
              'h1{border-bottom:2px solid #e0e0e0;padding-bottom:.5rem}'
              '.card{border:1px solid #e0e0e0;border-radius:8px;padding:1.5rem;margin:1rem 0}'
              'a.big{display:inline-block;background:#2980b9;color:#fff;'
              'text-decoration:none;padding:.75rem 2rem;border-radius:6px;'
              'font-size:1.2rem;font-weight:bold;margin-top:.5rem}'
              'a.big:hover{background:#1a6a9a}'
              'a.snap{background:#e67e22}'
              'a.snap:hover{background:#c96a12}'
              'ul{list-style:none;padding:0}'
              'li{margin:.4rem 0}'
              'li a{color:#2980b9;text-decoration:none}'
              'li a:hover{text-decoration:underline}'
          )

          parts = [
              '<!DOCTYPE html>',
              '<html lang="en">',
              '<head>',
              '<meta charset="UTF-8">',
              '<meta name="viewport" content="width=device-width,initial-scale=1">',
              '<title>SignPath Maven Plugin \u2013 Documentation</title>',
              '<style>' + css + '</style>',
              '</head>',
              '<body>',
              '<h1>SignPath Maven Plugin</h1>',
              '<p>Maven plugin that signs artifacts via the '
              '<a href="https://signpath.io">SignPath REST API</a>.</p>',
          ]

          if has_latest:
              parts += [
                  '<div class="card">',
                  '<h2>Latest Release</h2>',
                  '<p>Documentation for the most recent stable release.</p>',
                  '<a class="big" href="latest/">Latest &#8594;</a>',
                  '</div>',
              ]

          if has_snapshot:
              parts += [
                  '<div class="card">',
                  '<h2>Snapshot</h2>',
                  '<p>Documentation built from the <code>main</code> branch (may be unstable).</p>',
                  '<a class="big snap" href="snapshot/">Snapshot &#8594;</a>',
                  '</div>',
              ]

          if versions:
              parts.append('<div class="card"><h2>All Releases</h2><ul>')
              parts += ['<li><a href="%s/">v%s</a></li>' % (v, v) for v in versions]
              parts.append('</ul></div>')

          parts += ['</body>', '</html>']

          with open(os.path.join(store, 'index.html'), 'w') as f:
              f.write('\n'.join(parts) + '\n')

          print("Generated index.html with %d release(s)" % len(versions))
          PYEOF

      - name: Configure Pages
        uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
        with:
          path: target/gh-pages-store

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5

      # Push the updated tree back so the next run can check it out.
      - name: Commit and push gh-pages storage branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git -C target/gh-pages-store config user.name "github-actions[bot]"
          git -C target/gh-pages-store config user.email "github-actions[bot]@users.noreply.github.com"
          git -C target/gh-pages-store add -A
          if git -C target/gh-pages-store diff --cached --quiet; then
            echo "No changes to commit"
          else
            git -C target/gh-pages-store commit -m "chore: update site for ${GITHUB_REF_NAME}"
            git -C target/gh-pages-store remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" 2>/dev/null \
              || git -C target/gh-pages-store remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
            git -C target/gh-pages-store push origin gh-pages
          fi
